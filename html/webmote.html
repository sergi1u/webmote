<!DOCTYPE html>
<html lang="es">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="UTF-8">
<title>Raspberry Web-Remote Control</title>

</head>
<body onload="init_webmote();">
<header>
<h1>Raspberry Web-Remote Control</h1>

<link rel="stylesheet" type="text/css" href="webmote.css">
</header>

<section>

MP3: <span class="selected_text" id="mp3_title">---</span>
<span class="span_spaces">&nbsp;</span>
Video: <span class="selected_text" id="video_title">---</span>
<span class="span_spaces">&nbsp;</span>
Subtitles: <span class="selected_text" id="video_subtitles">---</span>

<br/>
<input type="button" class="medium_button" id="btn_change_media" value="Select Media" />
<input type="button" class="medium_button" id="btn_swap_media" value="Swap" />

</section>

<section id="control_media">

<input type="button" class="remote_button" id="btn_start" value="Start MP3" />
<input type="button" class="remote_button" id="btn_stop" value="Stop"/>
<!--<input type="button" class="remote_button" id="btn_info" value="Info" /> -->
<input type="button" class="remote_button" id="btn_halt" value="Halt" />
<input type="button" class="remote_button" id="btn_subtitle" value="Subtitles" />
<br/>

<input type="button" class="remote_button" id="btn_volume_down" value="Vol. Dwn." />
<input type="button" class="remote_button" id="btn_volume_up" value="Vol. Up" />
<br/>

<input type="button" class="remote_button" id="btn_rw" value="Rewind" />
<input type="button" class="remote_button" id="btn_pause" value="|| >" />
<input type="button" class="remote_button" id="btn_ff" value="Fast Forwd." />
<br/>

<input type="button" class="remote_button" id="btn_left_600" value="<<" />
<input type="button" class="remote_button" id="btn_left_30" value="<" />
<input type="button" class="remote_button" id="btn_right_30" value=">" />
<input type="button" class="remote_button" id="btn_right_600" value=">>" />


</section>


<script languaje="text/javascript">

	"use strict";

	init_buttons();
	swap_media();

function init_webmote()
{

	var mp3 = localStorage.getItem("mp3");
	var video = localStorage.getItem("video");
	var subtitles = localStorage.getItem("subtitles");

	if(mp3 !== null)
		document.getElementById("mp3_title").innerHTML = mp3.slice( mp3.lastIndexOf("/") +1 );

	if( video !== null )
		document.getElementById("video_title").innerHTML = video.slice( video.lastIndexOf("/") +1 );

	if( subtitles !== null )
		document.getElementById("video_subtitles").innerHTML = subtitles.slice ( subtitles.lastIndexOf("/") +1 );

	//if ( video === null )
	//	return;

}


function change_media(){
	window.location.assign("/medialist.html");
}

function swap_media()
{
	var button =	document.getElementById("btn_start");
	var media = localStorage.getItem("media");
	var video = localStorage.getItem("video");
	var mp3 = localStorage.getItem("mp3");

	if(media === null ){
		if( mp3 != null && mp3 != '' ){
			localStorage.setItem('media','mp3');
			button.value = "Start MP3";
			button.onclick=function(){ 
				sendXhr("start_mp3");
		 	};
		}
		else if( video != null && video != '' ){
			localStorage.setItem('media','video');
			button.value = "Start video";
			button.onclick=function(){ 
				sendXhr("start");
		 	};
		}
	}
	else if ( media === 'mp3' && video != null && video != '')
	{
		localStorage.setItem('media','video');
		button.value = "Start video";
		button.onclick=function(){ 
			sendXhr("start");
	 	};
	}
	else if ( media === 'video' && mp3 != null && mp3 != '' )
	{
		localStorage.setItem('media','mp3');
		button.value = "Start MP3";
		button.onclick=function(){ 
			sendXhr("start_mp3");
	 	};
	}
	else
		localStorage.removeItem('media');



}

/*
Asings events to buttons
*/
function init_buttons(){


	document.getElementById("btn_change_media").onclick=function(){ 
		change_media();
	 };

	document.getElementById("btn_start").onclick=function(){ 
		sendXhr("start_mp3");
	 };

	document.getElementById("btn_stop").onclick=function(){ 
		sendXhr("stop");
	 };

	document.getElementById("btn_swap_media").onclick=function(){ 
		swap_media();
	 };

	document.getElementById("btn_pause").onclick=function(){ 
		sendXhr("pause");
	 };

/*
	document.getElementById("btn_info").onclick=function(){ 
		sendXhr("info");
	 };
*/

	document.getElementById("btn_subtitle").onclick=function(){ 
		sendXhr("subtitle");
	 };


/*
	document.getElementById("btn_halt").onclick=function(){ 
		sendXhr("halt");
	 };
*/
	document.getElementById("btn_rw").onclick=function(){ 
		sendXhr("rw");
	 };

	document.getElementById("btn_ff").onclick=function(){ 
		sendXhr("ff");
	 };

	document.getElementById("btn_volume_up").onclick=function(){ 
		sendXhr("vol+");
	 };
	document.getElementById("btn_volume_down").onclick=function(){ 
		sendXhr("vol-");
	 };

	document.getElementById("btn_left_600").onclick=function(){ 
		sendXhr("skip--");
	 };
	document.getElementById("btn_right_600").onclick=function(){ 
		sendXhr("skip++");
	 };
	document.getElementById("btn_left_30").onclick=function(){ 
		sendXhr("skip-");
	 };
	document.getElementById("btn_right_30").onclick=function(){ 
		sendXhr("skip+");
	 };
}


function sendXhr( signal )
{
	var post_data = "";
	var xhr = new XMLHttpRequest();
	var mp3,video,subtitles;


	if ( signal == null )
		return;

	post_data = "c=" + signal;

	if( signal === "start" ){

		video = localStorage.getItem("video");
		subtitles = localStorage.getItem("subtitles");

		post_data += "&video=" + video;
		post_data += "&subtitles=" + subtitles;

	}

	else if( signal === "start_mp3" ){

		mp3 = localStorage.getItem("mp3");

		post_data += "&mp3=" + mp3;
	}

	xhr.onerror = function(e){
		alert( "Error creating xhr signal." );
	}

	xhr.onprogress = function(e){
		var ratio = e.loaded / e.total;
		//debug( ratio + "% descargado." );
	}

	// Request completed
	xhr.onreadystatechange=function()
	{
		if (xhr.readyState == 4 && xhr.status == 200)
		{
			if( signal === 'stop' ){
			}
		}
	}

	xhr.open("POST", "omx_command", true);


	// Envia el formulario
	xhr.setRequestHeader ('Content-type','application/x-www-form-urlencoded');
	xhr.send( post_data );

}


</script>

</body>
</html>
